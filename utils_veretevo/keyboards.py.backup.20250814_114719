import logging
from telegram import ReplyKeyboardMarkup, InlineKeyboardMarkup, InlineKeyboardButton
from config_veretevo.constants import GENERAL_DIRECTOR_ID
from typing import Any, Dict, Optional

def main_menu_keyboard(chat_type: str = "private", user_id: int = None) -> ReplyKeyboardMarkup | None:
    logging.debug(f"main_menu_keyboard –≤—ã–∑–≤–∞–Ω –¥–ª—è chat_type={chat_type}, user_id={user_id}")
    if chat_type != "private":
        return None
    buttons = [["üìå –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞", "üìã –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á"], ["–ú–æ–∏ –∑–∞–¥–∞—á–∏"]]
    # –ö–Ω–æ–ø–∫–∞ '–ü–æ–º–æ—â—å' –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–±—Ä–∞–Ω–∞ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    return ReplyKeyboardMarkup(buttons, resize_keyboard=True)


def get_task_action_keyboard(task: Dict[str, Any], user_id: Optional[int], department_members: Optional[list] = None) -> InlineKeyboardMarkup:
    from config_veretevo.constants import GENERAL_DIRECTOR_ID
    status = task.get('status')
    author_id = task.get('author_id')
    assistant_id = task.get('assistant_id')
    buttons = []
    # –ö–Ω–æ–ø–∫–∏ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –¥–ª—è –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö/–æ—Ç–º–µ–Ω—ë–Ω–Ω—ã—Ö –∑–∞–¥–∞—á
    if status in ['–∑–∞–≤–µ—Ä—à–µ–Ω–æ', '–æ—Ç–º–µ–Ω–µ–Ω–æ']:
        return InlineKeyboardMarkup([])
    
    # –ï—Å–ª–∏ user_id –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω (–≥—Ä—É–ø–ø–∞) ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –ø–æ —Å—Ç–∞—Ç—É—Å—É –∑–∞–¥–∞—á–∏
    if user_id is None:
        if status == '–Ω–æ–≤–∞—è':
            buttons.append(InlineKeyboardButton("–í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É", callback_data=f"take_{task.get('id','')}") )
        if status != '–∑–∞–≤–µ—Ä—à–µ–Ω–æ' and status != '–æ—Ç–º–µ–Ω–µ–Ω–æ':
            buttons.append(InlineKeyboardButton("‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å", callback_data=f"finish_{task.get('id','')}") )
        if status != '–∑–∞–≤–µ—Ä—à–µ–Ω–æ' and status != '–æ—Ç–º–µ–Ω–µ–Ω–æ':
            buttons.append(InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", callback_data=f"cancel_{task.get('id','')}") )
        return InlineKeyboardMarkup([buttons])
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    is_director = user_id == GENERAL_DIRECTOR_ID
    is_author = user_id == author_id
    is_assistant = user_id == assistant_id
    is_department_member = False
    if department_members is not None:
        is_department_member = str(user_id) in department_members
    
    # "–í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É" ‚Äî –µ—Å–ª–∏ –∑–∞–¥–∞—á–∞ –Ω–æ–≤–∞—è –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî —á–ª–µ–Ω –æ—Ç–¥–µ–ª–∞ –∏–ª–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä
    if status == '–Ω–æ–≤–∞—è':
        if is_director or is_department_member:
            buttons.append(InlineKeyboardButton("–í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É", callback_data=f"take_{task.get('id','')}") )
    
    # "–ó–∞–≤–µ—Ä—à–∏—Ç—å" ‚Äî –µ—Å–ª–∏ –∑–∞–¥–∞—á–∞ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞/–æ—Ç–º–µ–Ω–µ–Ω–∞ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–ª–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä
    if status != '–∑–∞–≤–µ—Ä—à–µ–Ω–æ' and status != '–æ—Ç–º–µ–Ω–µ–Ω–æ':
        if is_director or is_assistant:
            buttons.append(InlineKeyboardButton("‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å", callback_data=f"finish_{task.get('id','')}") )
    
    # "–û—Ç–º–µ–Ω–∏—Ç—å" ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∞ –∏–ª–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞, –µ—Å–ª–∏ –∑–∞–¥–∞—á–∞ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞/–æ—Ç–º–µ–Ω–µ–Ω–∞
    if status != '–∑–∞–≤–µ—Ä—à–µ–Ω–æ' and status != '–æ—Ç–º–µ–Ω–µ–Ω–æ':
        if is_director or is_author:
            buttons.append(InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", callback_data=f"cancel_{task.get('id','')}") )
    
    return InlineKeyboardMarkup([buttons])
