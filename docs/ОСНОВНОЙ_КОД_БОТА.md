# üîß –û–°–ù–û–í–ù–û–ô –ö–û–î –ë–û–¢–ê VERETEVO TEAM

## üìã –ì–õ–ê–í–ù–´–ô –§–ê–ô–õ - main.py

```python
import time
import socket
import os
import logging
import asyncio
import datetime
import pytz
from telegram.ext import ApplicationBuilder
from config_veretevo.env import TELEGRAM_TOKEN
from handlers_veretevo.menu import register_menu_handlers
from handlers_veretevo.tasks import register_task_handlers
from handlers_veretevo.reports import register_report_handlers, send_morning_report, send_evening_report
from handlers_veretevo.gpt_handlers import register_gpt_handlers
from services_veretevo.department_service import load_departments, DEPARTMENTS
import requests
from config_veretevo.constants import GENERAL_DIRECTOR_ID
import threading
from utils_veretevo.todoist_sync_polling import sync_todoist_to_bot
from utils_veretevo.group_monitor import GroupMonitor
import json

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –¥–ª—è –º–æ—Å–∫–æ–≤—Å–∫–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
os.environ['TZ'] = 'Europe/Moscow'

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã
LOGS_DIR = "logs"
TASKS_FILE = "data/tasks.json"

# –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è application
# –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
_notify_start_called = False

def notify_start():
    global _notify_start_called
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–æ –ª–∏ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    if _notify_start_called:
        print(f"[WARN] notify_start() —É–∂–µ –±—ã–ª–∞ –≤—ã–∑–≤–∞–Ω–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º")
        logging.info(f"[WARN] notify_start() —É–∂–µ –±—ã–ª–∞ –≤—ã–∑–≤–∞–Ω–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º")
        return
    
    try:
        url = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage"
        call_time = time.time()
        hostname = socket.gethostname()
        timestamp = time.strftime("%Y-%m-%d %H:%M:%S")
        msg = f"Veretevo Bot –±—ã–ª –∑–∞–ø—É—â–µ–Ω/–ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ!\n\nüÜî ID: {call_time}\nüñ•Ô∏è Host: {hostname}\n‚è∞ Time: {timestamp}"
        print(f"[INFO] –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞–ø—É—Å–∫–µ –≤ {GENERAL_DIRECTOR_ID}")
        logging.info(f"[INFO] –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞–ø—É—Å–∫–µ –≤ {GENERAL_DIRECTOR_ID}")
        response = requests.post(url, data={"chat_id": GENERAL_DIRECTOR_ID, "text": msg}, timeout=5)
        print(f"[INFO] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ, —Å—Ç–∞—Ç—É—Å: {response.status_code}")
        logging.info(f"[INFO] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ, —Å—Ç–∞—Ç—É—Å: {response.status_code}")
        
        # –û—Ç–º–µ—á–∞–µ–º, —á—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –±—ã–ª–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
        _notify_start_called = True
        
    except Exception as e:
        print(f"[WARN] –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram: {e}")
        logging.info(f"[WARN] –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram: {e}")

def periodic_todoist_sync(application=None):
    try:
        with open(TASKS_FILE, 'r', encoding='utf-8') as f:
            tasks = json.load(f)
    except Exception:
        tasks = []
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫
    def sync_worker():
        try:
            sync_todoist_to_bot(tasks, GENERAL_DIRECTOR_ID, application)
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ
            with open(TASKS_FILE, 'w', encoding='utf-8') as f:
                json.dump(tasks, f, ensure_ascii=False, indent=2)
        except Exception as e:
            print(f"[WARN] –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å Todoist: {e}")
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –≤ —Ñ–æ–Ω–µ
    sync_thread = threading.Thread(target=sync_worker, daemon=True)
    sync_thread.start()
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–Ω–æ–≤–∞ —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç
    threading.Timer(300, lambda: periodic_todoist_sync(application)).start()

def setup_logging():
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è"""
    os.makedirs(LOGS_DIR, exist_ok=True)
    log_formatter = logging.Formatter("%(asctime)s - %(name)s - %(levelname)s - %(message)s")
    file_handler = logging.FileHandler(f"{LOGS_DIR}/bot.log", encoding="utf-8")
    file_handler.setFormatter(log_formatter)
    stream_handler = logging.StreamHandler()
    stream_handler.setFormatter(log_formatter)
    root_logger = logging.getLogger()
    root_logger.setLevel(logging.DEBUG)
    root_logger.handlers = []  # –£–±–∏—Ä–∞–µ–º –≤—Å–µ —Å—Ç–∞—Ä—ã–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã
    root_logger.addHandler(file_handler)
    root_logger.addHandler(stream_handler)

def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞"""
    setup_logging()
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç–¥–µ–ª—ã
    load_departments()
    
    # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    application = ApplicationBuilder().token(TELEGRAM_TOKEN).build()
    
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    register_menu_handlers(application)
    register_task_handlers(application)
    register_report_handlers(application)
    register_gpt_handlers(application)
    
    # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –æ—Ç—á–µ—Ç–æ–≤
    setup_report_scheduler(application)
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —Å Todoist
    periodic_todoist_sync(application)
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≥—Ä—É–ø–ø
    start_monitoring()
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–ø—É—Å–∫–µ
    notify_start()
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    application.run_polling()
```

## üéÆ –û–ë–†–ê–ë–û–¢–ß–ò–ö –ú–ï–ù–Æ - handlers_veretevo/menu.py

### –ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:

```python
def show_main_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–∫–∞–∑–∞—Ç—å –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é (—Ç–æ–ª—å–∫–æ –≤ –ª–∏—á–Ω—ã—Ö —á–∞—Ç–∞—Ö)"""
    if update.effective_chat.type != 'private':
        return
    
    keyboard = [
        ['üìå –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞'],
        ['üìã –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á'],
        ['–ú–æ–∏ –∑–∞–¥–∞—á–∏']
    ]
    
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    update.message.reply_text(
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=reply_markup
    )

def handle_new_task(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏"""
    if update.effective_chat.type != 'private':
        return
    
    # –õ–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏
    # ...

def handle_task_list(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–ø–∏—Å–∫–∞ –∑–∞–¥–∞—á"""
    if update.effective_chat.type != 'private':
        return
    
    # –õ–æ–≥–∏–∫–∞ –ø–æ–∫–∞–∑–∞ –∑–∞–¥–∞—á
    # ...
```

## üìù –û–ë–†–ê–ë–û–¢–ß–ò–ö –ó–ê–î–ê–ß - handlers_veretevo/tasks.py

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:

```python
def create_task(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏"""
    user_id = update.effective_user.id
    user_name = update.effective_user.first_name
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
    if not context.user_data.get('task_text'):
        update.message.reply_text("‚ùå –¢–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º")
        return
    
    task_text = context.user_data['task_text']
    department = context.user_data.get('selected_department')
    
    # –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
    task_id = str(uuid.uuid4())
    task = {
        "id": task_id,
        "text": task_text,
        "department": department,
        "status": TASK_STATUS_NEW,
        "created_by": user_name,
        "created_at": datetime.now().isoformat(),
        "todoist_id": None
    }
    
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ —Ñ–∞–π–ª
    save_task(task)
    
    # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    update.message.reply_text(f"‚úÖ –ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞!\n\nüìù {task_text}\nüè¢ –û—Ç–¥–µ–ª: {department}")
    
    # –û—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    context.user_data.clear()

def update_task_status(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á–∏"""
    # –õ–æ–≥–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
    # ...

def show_tasks_by_department(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–¥–∞—á–∏ –ø–æ –æ—Ç–¥–µ–ª—É"""
    # –õ–æ–≥–∏–∫–∞ –ø–æ–∫–∞–∑–∞ –∑–∞–¥–∞—á
    # ...
```

## üîß –°–ï–†–í–ò–° –ó–ê–î–ê–ß - services_veretevo/task_service.py

```python
import json
import logging
from datetime import datetime
from typing import List, Dict, Optional
from config_veretevo.constants import TASKS_FILE, TASK_STATUSES

logger = logging.getLogger(__name__)

def load_tasks() -> List[Dict]:
    """–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ –∑–∞–¥–∞—á–∏ –∏–∑ —Ñ–∞–π–ª–∞"""
    try:
        with open(TASKS_FILE, 'r', encoding='utf-8') as f:
            data = json.load(f)
            return data.get('tasks', [])
    except FileNotFoundError:
        logger.warning("–§–∞–π–ª –∑–∞–¥–∞—á –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π")
        return []
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á: {e}")
        return []

def save_task(task: Dict) -> bool:
    """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–¥–∞—á—É –≤ —Ñ–∞–π–ª"""
    try:
        tasks = load_tasks()
        tasks.append(task)
        
        with open(TASKS_FILE, 'w', encoding='utf-8') as f:
            json.dump({'tasks': tasks}, f, ensure_ascii=False, indent=2)
        
        logger.info(f"–ó–∞–¥–∞—á–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: {task['id']}")
        return True
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏: {e}")
        return False

def update_task(task_id: str, updates: Dict) -> bool:
    """–û–±–Ω–æ–≤–∏—Ç—å –∑–∞–¥–∞—á—É"""
    try:
        tasks = load_tasks()
        
        for task in tasks:
            if task['id'] == task_id:
                task.update(updates)
                break
        
        with open(TASKS_FILE, 'w', encoding='utf-8') as f:
            json.dump({'tasks': tasks}, f, ensure_ascii=False, indent=2)
        
        logger.info(f"–ó–∞–¥–∞—á–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞: {task_id}")
        return True
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏: {e}")
        return False

def get_tasks_by_department(department: str) -> List[Dict]:
    """–ü–æ–ª—É—á–∏—Ç—å –∑–∞–¥–∞—á–∏ –ø–æ –æ—Ç–¥–µ–ª—É"""
    tasks = load_tasks()
    return [task for task in tasks if task.get('department') == department]

def get_user_tasks(user_name: str) -> List[Dict]:
    """–ü–æ–ª—É—á–∏—Ç—å –∑–∞–¥–∞—á–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    tasks = load_tasks()
    return [task for task in tasks if task.get('created_by') == user_name]
```

## üîÑ –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø TODOIST - utils_veretevo/todoist_sync_polling.py

```python
import requests
import json
import logging
from typing import List, Dict
from config_veretevo.constants import GENERAL_DIRECTOR_ID

logger = logging.getLogger(__name__)

def sync_todoist_to_bot(tasks: List[Dict], director_id: int, application=None):
    """–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–¥–∞—á —Å Todoist"""
    try:
        # –ü–æ–ª—É—á–∞–µ–º –∑–∞–¥–∞—á–∏ –∏–∑ Todoist
        todoist_tasks = get_todoist_tasks()
        
        # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å –ª–æ–∫–∞–ª—å–Ω—ã–º–∏ –∑–∞–¥–∞—á–∞–º–∏
        for todoist_task in todoist_tasks:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ç–∞–∫–∞—è –∑–∞–¥–∞—á–∞
            existing_task = find_task_by_todoist_id(tasks, todoist_task['id'])
            
            if not existing_task:
                # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É
                new_task = create_task_from_todoist(todoist_task)
                tasks.append(new_task)
                
                # –£–≤–µ–¥–æ–º–ª—è–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞
                if application:
                    notify_new_task(application, director_id, new_task)
        
        logger.info(f"–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞: {len(todoist_tasks)} –∑–∞–¥–∞—á")
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å Todoist: {e}")

def get_todoist_tasks() -> List[Dict]:
    """–ü–æ–ª—É—á–∏—Ç—å –∑–∞–¥–∞—á–∏ –∏–∑ Todoist API"""
    # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–¥–∞—á –∏–∑ Todoist
    # ...

def create_task_from_todoist(todoist_task: Dict) -> Dict:
    """–°–æ–∑–¥–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω—É—é –∑–∞–¥–∞—á—É –∏–∑ Todoist"""
    return {
        "id": str(uuid.uuid4()),
        "text": todoist_task['content'],
        "department": "–û–±—â–∏–µ –∑–∞–¥–∞—á–∏",
        "status": TASK_STATUS_NEW,
        "created_by": "Todoist",
        "created_at": datetime.now().isoformat(),
        "todoist_id": todoist_task['id']
    }
```

## üé§ GPT –û–ë–†–ê–ë–û–¢–ß–ò–ö - handlers_veretevo/gpt_handlers.py

```python
from telegram import Update
from telegram.ext import ContextTypes
from config_veretevo.constants import GENERAL_DIRECTOR_ID
from services_veretevo.gpt_service import process_gpt_request
from utils_veretevo.yandex_speechkit import transcribe_voice_message

def handle_voice_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    user_id = update.effective_user.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ GPT
    if user_id != GENERAL_DIRECTOR_ID:
        update.message.reply_text("‚ùå GPT —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä—É")
        return
    
    try:
        # –ü–æ–ª—É—á–∞–µ–º —Ñ–∞–π–ª –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        voice_file = context.bot.get_file(update.message.voice.file_id)
        
        # –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä—É–µ–º –≥–æ–ª–æ—Å
        transcription = transcribe_voice_message(voice_file)
        
        # –£–ª—É—á—à–∞–µ–º —á–µ—Ä–µ–∑ GPT
        improved_text = process_gpt_request(f"–£–ª—É—á—à–∏ —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç: {transcription}")
        
        update.message.reply_text(f"üé§ –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è:\n{improved_text}")
        
    except Exception as e:
        update.message.reply_text(f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")

def handle_gpt_request(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ GPT –∑–∞–ø—Ä–æ—Å–æ–≤"""
    user_id = update.effective_user.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
    if user_id != GENERAL_DIRECTOR_ID:
        update.message.reply_text("‚ùå GPT —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä—É")
        return
    
    try:
        # –ü–æ–ª—É—á–∞–µ–º –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_request = update.message.text
        
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ GPT
        response = process_gpt_request(user_request)
        
        update.message.reply_text(f"ü§ñ GPT –æ—Ç–≤–µ—Ç:\n{response}")
        
    except Exception as e:
        update.message.reply_text(f"‚ùå –û—à–∏–±–∫–∞ GPT –æ–±—Ä–∞–±–æ—Ç–∫–∏: {e}")
```

## üìä –°–ò–°–¢–ï–ú–ê –û–¢–ß–ï–¢–û–í - handlers_veretevo/reports.py

```python
import asyncio
from datetime import datetime, time
from telegram.ext import ContextTypes
from config_veretevo.env import ASSISTANTS_CHAT_ID
from services_veretevo.task_service import load_tasks

async def send_morning_report(context: ContextTypes.DEFAULT_TYPE):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ —É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –æ—Ç—á–µ—Ç–∞"""
    try:
        tasks = load_tasks()
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç
        report = "üåÖ –£–¢–†–ï–ù–ù–ò–ô –û–¢–ß–ï–¢\n\n"
        report += f"üìÖ –î–∞—Ç–∞: {datetime.now().strftime('%d.%m.%Y')}\n"
        report += f"üìä –í—Å–µ–≥–æ –∑–∞–¥–∞—á: {len(tasks)}\n"
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
        status_counts = {}
        for task in tasks:
            status = task.get('status', '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
            status_counts[status] = status_counts.get(status, 0) + 1
        
        for status, count in status_counts.items():
            report += f"‚Ä¢ {status}: {count}\n"
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ —á–∞—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–≤
        await context.bot.send_message(
            chat_id=ASSISTANTS_CHAT_ID,
            text=report
        )
        
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –æ—Ç—á–µ—Ç–∞: {e}")

async def send_evening_report(context: ContextTypes.DEFAULT_TYPE):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ –≤–µ—á–µ—Ä–Ω–µ–≥–æ –æ—Ç—á–µ—Ç–∞"""
    try:
        tasks = load_tasks()
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç
        report = "üåÜ –í–ï–ß–ï–†–ù–ò–ô –û–¢–ß–ï–¢\n\n"
        report += f"üìÖ –î–∞—Ç–∞: {datetime.now().strftime('%d.%m.%Y')}\n"
        report += f"üìä –í—Å–µ–≥–æ –∑–∞–¥–∞—á: {len(tasks)}\n"
        
        # –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ –∑–∞ –¥–µ–Ω—å
        today = datetime.now().date()
        completed_today = [
            task for task in tasks 
            if task.get('status') == '–∑–∞–≤–µ—Ä—à–µ–Ω–æ' and 
            datetime.fromisoformat(task['created_at']).date() == today
        ]
        
        report += f"‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è: {len(completed_today)}\n"
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ —á–∞—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–≤
        await context.bot.send_message(
            chat_id=ASSISTANTS_CHAT_ID,
            text=report
        )
        
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤–µ—á–µ—Ä–Ω–µ–≥–æ –æ—Ç—á–µ—Ç–∞: {e}")
```

## üîß –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø - config_veretevo/env.py

```python
import os
from dotenv import load_dotenv

load_dotenv()

# –ë–æ–µ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º)
TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")
ASSISTANTS_CHAT_ID_STR = os.getenv("ASSISTANTS_CHAT_ID")
if TELEGRAM_TOKEN is None:
    raise ValueError("TELEGRAM_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è")
if ASSISTANTS_CHAT_ID_STR is None:
    raise ValueError("ASSISTANTS_CHAT_ID –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è")
ASSISTANTS_CHAT_ID = int(ASSISTANTS_CHAT_ID_STR)
FINANCE_CHAT_ID = int(os.getenv("FINANCE_CHAT_ID", "-4935953370"))

# Yandex SpeechKit Configuration
YANDEX_SPEECHKIT_API_KEY = os.getenv("YANDEX_SPEECHKIT_API_KEY")
YANDEX_FOLDER_ID = os.getenv("YANDEX_FOLDER_ID")

# Yandex GPT Configuration
YANDEX_GPT_API_KEY = os.getenv("YANDEX_GPT_API_KEY")

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö Yandex SpeechKit
if YANDEX_SPEECHKIT_API_KEY is None:
    print("[–ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï] YANDEX_SPEECHKIT_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
if YANDEX_FOLDER_ID is None:
    print("[–ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï] YANDEX_FOLDER_ID –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö Yandex GPT
if YANDEX_GPT_API_KEY is None:
    print("[–ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï] YANDEX_GPT_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω - GPT-–ø–æ–¥—Å–∫–∞–∑–∫–∏ –±—É–¥—É—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã")
```

## üìÅ –°–¢–†–£–ö–¢–£–†–ê –î–ê–ù–ù–´–•

### tasks.json
```json
{
  "tasks": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "text": "–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –æ—Ç—á–µ—Ç –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º",
      "department": "–ü—Ä–æ–¥–∞–∂–∏",
      "status": "–≤ —Ä–∞–±–æ—Ç–µ",
      "created_by": "–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤",
      "created_at": "2024-01-15T10:30:00",
      "todoist_id": "123456789"
    }
  ]
}
```

### departments_config.json
```json
{
  "departments": [
    {
      "name": "–ü—Ä–æ–¥–∞–∂–∏",
      "chat_id": "-1001234567890",
      "members": ["–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤", "–ú–∞—Ä–∏—è –°–∏–¥–æ—Ä–æ–≤–∞"]
    },
    {
      "name": "–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞",
      "chat_id": "-1001234567891",
      "members": ["–ê–ª–µ–∫—Å–µ–π –ö–æ–∑–ª–æ–≤", "–ï–ª–µ–Ω–∞ –ù–æ–≤–∏–∫–æ–≤–∞"]
    }
  ]
}
```

---

**–í–∞–∂–Ω–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞:**
1. –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
2. GPT —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –≥–µ–Ω–µ—Ä–∞–ª—å–Ω–æ–º—É –¥–∏—Ä–µ–∫—Ç–æ—Ä—É (ID: 406325177)
3. –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –ª–∏—á–Ω—ã—Ö —á–∞—Ç–∞—Ö
4. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Todoist –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
5. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç—á–µ—Ç—ã –≤ 9:00 –∏ 18:00 (–ú–°–ö)
