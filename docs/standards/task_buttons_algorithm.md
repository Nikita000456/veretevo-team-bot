# Алгоритм работы с кнопками задач и уведомлениями

## Общие положения

- Данный алгоритм определяет поведение кнопок под сообщением с задачей в группах (например, «Финансы», «Ассистенты» и других).
- Изменения в этот документ могут вноситься только вручную пользователем или по отдельному прямому указанию пользователя.

---

## Кнопки под задачей

В сообщении с задачей отображаются три кнопки:
- **Взять в работу**
- **Завершить**
- **Отменить**

### Функционал кнопок

- **Взять в работу** — выполняет две функции:
  1. Если у задачи нет ответственного, пользователь, нажавший кнопку, становится ответственным за выполнение задачи, и задача переходит в статус «В работе».
  2. Если у задачи уже есть ответственный, но пользователь хочет явно подтвердить, что он приступает к выполнению задачи (например, если задача уже назначена на него, но ещё не взята в работу), задача также переходит в статус «В работе», а пользователь становится активным исполнителем.
- **Завершить** — задача помечается как выполненная, статус меняется на «Завершена».
- **Отменить** — задача отменяется, статус меняется на «Отменена».

### Вид кнопок

- Все три кнопки расположены в одном ряду под сообщением с задачей.
- Для удобства восприятия используются разные цвета и иконки:
  - «Взять в работу» — нейтральная или синяя кнопка
  - «Завершить» — зелёная с галочкой
  - «Отменить» — красная с крестиком

---

## Взаимодействие с кнопками

### 1. Кнопка «Взять в работу»
- Если у задачи нет ответственного, пользователь становится ответственным, задача переходит в статус «В работе».
- Если у задачи уже есть ответственный (и это текущий пользователь), задача переходит в статус «В работе».
- В тексте сообщения появляется имя ответственного (если его не было) и новый статус.
- Кнопка «Взять в работу» исчезает.
- В исходном сообщении (и во всех его копиях) остаются только две кнопки: «Завершить» и «Отменить».
- Кнопка исчезает во всех местах, где есть это сообщение (группы, личные чаты и т.д.), так как бот редактирует исходное сообщение по его message_id.
- **Изменения (статус, кнопки, текст) синхронизируются во всех чатах, где есть это сообщение. См. раздел «Общее правило».**
- Оригинальное сообщение с задачей не удаляется, оно редактируется (обновляется текст и кнопки).
- Всегда отправляется отдельное уведомление-комментарий только в ту группу (отдел), которой назначена задача.

### 2. Кнопка «Завершить»
- Статус задачи меняется на «Завершена».
- В тексте сообщения появляется новый статус, может добавляться имя завершившего.
- Все кнопки («Завершить» и «Отменить») исчезают.
- В исходном сообщении (и во всех его копиях) больше не отображаются никакие кнопки.
- Кнопки исчезают во всех местах, где есть это сообщение, так как бот редактирует исходное сообщение.
- Оригинальное сообщение с задачей не удаляется, оно редактируется (обновляется текст и убираются кнопки).
- Всегда отправляется отдельное уведомление-комментарий только в ту группу (отдел), которой назначена задача.
- **Изменения (статус, кнопки, текст) синхронизируются во всех чатах, где есть это сообщение. См. раздел «Общее правило».**
- См. раздел «Общее правило».

### 3. Кнопка «Отменить»
- Статус задачи меняется на «Отменена».
- В тексте сообщения появляется новый статус.
- Все кнопки («Завершить» и «Отменить») исчезают.
- В исходном сообщении (и во всех его копиях) больше не отображаются никакие кнопки.
- Кнопки исчезают во всех местах, где есть это сообщение, так как бот редактирует исходное сообщение.
- Оригинальное сообщение с задачей не удаляется, оно редактируется (обновляется текст и убираются кнопки).
- Всегда отправляется отдельное уведомление-комментарий только в ту группу (отдел), которой назначена задача.
- **Отменить задачу может только генеральный директор или автор задачи. Для других пользователей кнопка «Отменить» не отображается.**
- **Изменения (статус, кнопки, текст) синхронизируются во всех чатах, где есть это сообщение. См. раздел «Общее правило».**
- См. раздел «Общее правило».

---

## Общее правило

**Главное правило синхронизации задач и кнопок**

> Бот всегда редактирует исходное сообщение с задачей по его уникальному идентификатору (message_id).
> Это означает, что любые изменения задачи (статус, текст, кнопки) автоматически синхронизируются во всех чатах, где присутствует это сообщение:
> — в общих группах бота (группах отделов, например, ассистенты, финансисты и т.д.),
> — а также в личных сообщениях бота с пользователем.
>
> В результате, одно и то же сообщение с задачей всегда выглядит одинаково для всех участников во всех местах, где оно есть.
>
> **Это правило обязательно для соблюдения и не подлежит изменению без отдельного согласования.**

- При любом действии с задачей (взятие в работу, завершение, отмена) всегда отправляется отдельное уведомление-комментарий только в ту группу (отдел), которой назначена задача.
- **Все уведомления о действиях с кнопками отправляются в виде отдельного комментария к задаче только в соответствующую группу (отдел), которой назначена задача.**
- **Кнопка «Отменить» доступна только генеральному директору или автору задачи.**
- **Нельзя выполнять одно и то же действие повторно: нельзя завершить уже завершённую задачу, отменить уже отменённую, взять в работу уже находящуюся в работе задачу и т.д. Если действие невозможно, пользователю показывается соответствующее уведомление.** 
- **К задаче можно добавить комментарий вручную, например, с помощью отдельной команды «Комментировать». Такие комментарии отображаются в истории задачи и видны всем участникам группы.** 
- **Имя в уведомлении всегда соответствует пользователю, который совершил действие (нажал кнопку), а не автору или исполнителю задачи.**

---

## Стандартизация

Работа с кнопками во всех группах (ассистенты, финансисты, будущие отделы) должна быть реализована строго по вашему документу (task_buttons_algorithm.md).

* Любые другие действия (например, reply пользователю, не предусмотренные вашим алгоритмом) — удалить.

---

## Пример формата уведомления

* 🟡 Иван взял задачу «Сделать отчёт» в работу
* ✅ Иван завершил задачу «Сделать отчёт»
* ❌ Иван отменил задачу «Сделать отчёт»